# TypeScript Type Generation

The Jiki API automatically generates TypeScript types from Rails schemas to provide type safety for frontend applications (code-videos and front-end repos).

## Overview

TypeScript types are generated from:
- **Video Production Node Schemas**: `app/commands/video_production/node/schemas/`
- **INPUTS constants**: Node input field definitions
- **PROVIDER_CONFIGS constants**: Provider-specific configuration schemas

Generated types are published as the `@jiki/api-types` npm package in the `typescript/` directory.

## Architecture

### Generator Location
- **Main Generator**: `lib/typescript_generator/generator.rb`
- **Schema Parser**: `lib/typescript_generator/input_schema_generator.rb`
- **Rake Tasks**: `lib/tasks/typescript.rake`

### Generated Structure

```typescript
// Combined node type with discriminated unions
export type ComposeVideoNode = {
  type: 'compose-video';           // Node type discriminator
  inputs: {
    background: string;             // Required input
    overlay: string;                // Required input
  }
} & (
  | { provider: 'ffmpeg'; config: { // Provider discriminator
      position?: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right' | 'center';
      scale?: string;
    } }
);
```

### Key Features

1. **Type Discrimination**: Two levels of type narrowing
   - `type` field discriminates between node types
   - `provider` field discriminates between provider configs

2. **Required vs Optional**: Correctly maps Rails schema `required: true/false` to TypeScript `?`

3. **Field Types**: Maps Rails schema types to TypeScript
   - `:string` → `string`
   - `:integer` → `number`
   - `:boolean` → `boolean`
   - `:allowed_values` → union types (e.g., `'16:9' | '9:16' | '1:1'`)

4. **Array Support**: `:multiple` type becomes `string[]`

## Commands

### Generate Types
```bash
bundle exec rake typescript:generate
```

This will:
1. Load all schema classes from `app/commands/video_production/node/schemas/`
2. Extract `INPUTS` and `PROVIDER_CONFIGS` constants
3. Generate TypeScript interfaces with discriminated unions
4. Install dependencies with `pnpm install` (if needed)
5. Build TypeScript with `pnpm build`
6. Output to `typescript/dist/`

### Clean Generated Files
```bash
bundle exec rake typescript:clean
```

Removes `typescript/dist/` directory.

### Publish to npm (Optional)
```bash
bundle exec rake typescript:publish
```

Bumps version and publishes to npm registry.

## Workflow

### When Schema Changes

Whenever you modify schemas in `app/commands/video_production/node/schemas/`:

1. **Regenerate types**:
   ```bash
   bundle exec rake typescript:generate
   ```

2. **Verify output**: Check `typescript/src/nodes.ts`

3. **Commit changes**: Commit the generated source files in `typescript/src/`

### Pre-Commit Hook Automation

**TypeScript types are automatically generated by the pre-commit hook when schema files change.**

The `.husky/pre-commit` hook checks if any schema files are staged:
- If schema changes detected in `app/commands/video_production/node/schemas/`
- Runs `bundle exec rake typescript:generate`
- Automatically stages generated files in `typescript/src/`
- Includes them in your commit

This means you typically don't need to manually run `rake typescript:generate` - the hook handles it.

### CI Auto-Generation (Safety Net)

**TypeScript types are also auto-generated and committed by CI as a safety net.**

The CI workflow (`.github/workflows/ci.yml`) runs a `typescript` job after merges to `main`:

1. Runs `bundle exec rake typescript:generate`
2. Checks if any files in `typescript/src/` changed
3. If changes are detected, creates a commit with the updated types
4. Pushes the commit back to the `main` branch

This ensures:
- Types are always in sync with schemas on `main`
- If pre-commit hook is bypassed (e.g., `--no-verify`), CI catches it
- The frontend can safely pull from `main` knowing types are current

**Note**: If you bypass the pre-commit hook, you may see a follow-up commit from `github-actions[bot]` after your PR is merged.

### When Adding New Node Types

1. Create new schema file: `app/commands/video_production/node/schemas/my_node.rb`
2. Define `INPUTS` and `PROVIDER_CONFIGS` constants
3. Run `bundle exec rake typescript:generate`
4. New `MyNodeNode` type will be auto-generated

## Schema Conventions

### Input Schema Format

```ruby
INPUTS = {
  field_name: {
    type: :single,           # or :multiple for arrays
    required: true,          # or false for optional
    description: 'Field description for JSDoc'
  }
}.freeze
```

### Provider Config Format

```ruby
PROVIDER_CONFIGS = {
  provider_name: {
    field_name: {
      type: :string,                    # :string, :integer, :boolean
      required: false,
      allowed_values: ['val1', 'val2'], # Optional: creates union types
      description: 'Config field description'
    }
  }
}.freeze
```

## Generated Package Structure

```
typescript/
├── package.json          # npm package configuration
├── tsconfig.json         # TypeScript compiler config
├── .npmignore           # Excludes src from publish
├── README.md            # Usage instructions
├── src/
│   ├── index.ts         # Main entry point (generated)
│   ├── base.ts          # Base types (placeholder)
│   └── nodes.ts         # Node types (generated)
└── dist/               # Compiled output (gitignored)
    ├── index.d.ts
    ├── index.js
    ├── nodes.d.ts
    └── nodes.js
```

## Git Workflow

### What to Commit
- ✅ Source files: `typescript/src/*.ts` (auto-generated, should be committed)
- ✅ Config files: `package.json`, `tsconfig.json`, etc.
- ✅ Generator code: `lib/typescript_generator/**/*.rb`

### What NOT to Commit
- ❌ `typescript/dist/` (build artifacts, generated from src/)
- ❌ `typescript/node_modules/` (dependencies)
- ❌ Lock files: `pnpm-lock.yaml`, `package-lock.json`

### CI Auto-Commit Behavior

The `typescript` CI job only runs on pushes to `main` (after PR merges). It will:
- Generate types into `typescript/src/`
- Create a commit if files changed
- Push directly to `main`

This means you may see a follow-up commit from `github-actions[bot]` after your PR is merged if you forgot to regenerate types locally.

## Frontend Usage

### In code-videos Repo

```typescript
import type { ComposeVideoNode, GenerateAnimationNode } from '@jiki/api-types';

const node: ComposeVideoNode = {
  type: 'compose-video',
  inputs: { background: 'node-123', overlay: 'node-456' },
  provider: 'ffmpeg',
  config: { position: 'center', scale: '0.3' }
};

// TypeScript narrows types based on discriminators
if (node.provider === 'ffmpeg') {
  // node.config is typed as ComposeVideoFfmpegConfig
  const position = node.config.position; // 'top-left' | 'top-right' | ...
}
```

### Setting Up in Frontend

Add to `package.json`:
```json
{
  "dependencies": {
    "@jiki/api-types": "file:../api/typescript"
  }
}
```

Or publish to npm and use:
```json
{
  "dependencies": {
    "@jiki/api-types": "^1.0.0"
  }
}
```

## Type Safety Benefits

1. **Compile-time validation**: Frontend catches schema mismatches during development
2. **IDE autocomplete**: Full IntelliSense for node types and configs
3. **Refactoring safety**: Renaming fields updates frontend automatically
4. **Documentation**: JSDoc comments provide inline documentation
5. **Version tracking**: npm versioning keeps frontend/backend in sync

## Troubleshooting

### TypeScript Build Fails

Check for:
- Invalid Ruby syntax in schemas
- Missing `PROVIDER_CONFIGS` constant
- Empty `base.ts` file (should export at least `export {}`)

### Types Not Updating

1. Ensure schemas are saved
2. Run `bundle exec rake typescript:generate`
3. Check `typescript/src/nodes.ts` for updates
4. Verify `typescript/dist/nodes.d.ts` was rebuilt

### Frontend Not Seeing Updates

If using file: dependency:
```bash
cd ../code-videos  # or ../front-end
pnpm install       # Reinstall to pick up changes
```

If using npm registry, publish new version:
```bash
bundle exec rake typescript:publish
```

## Future Enhancements

Potential additions to the type generation system:

- **Model types**: Generate types for User, Course, Lesson models
- **API response types**: Generate types for serializer outputs
- **Validation schemas**: Generate Zod/Yup schemas for runtime validation
- **OpenAPI spec**: Generate OpenAPI/Swagger documentation
