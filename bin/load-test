#!/usr/bin/env bash
set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Default values
ENDPOINT="${1:-https://api.jiki.io/health-check}"
TOTAL_REQUESTS=1000

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}         Jiki API Load Testing Suite${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""
echo -e "Endpoint: ${YELLOW}${ENDPOINT}${NC}"
echo ""

# Function to run a test
run_test() {
  local name=$1
  local concurrency=$2
  local requests=$3

  echo -e "${GREEN}▶ ${name}${NC}"
  echo -e "  Concurrency: ${concurrency} | Total Requests: ${requests}"
  echo ""

  ab -n ${requests} -c ${concurrency} -q ${ENDPOINT} 2>&1 | \
    grep -E "Requests per second|Time per request|Connection Times|Percentage of the requests" | \
    sed 's/^/  /'

  echo ""
}

# Test 1: Baseline (single connection)
echo -e "${BLUE}━━━ Test 1: Baseline (Sequential Requests) ━━━${NC}"
run_test "Baseline Performance" 1 100

# Test 2: Normal load (within single task capacity)
echo -e "${BLUE}━━━ Test 2: Normal Load (Single Task) ━━━${NC}"
run_test "5 concurrent connections (50% of 1 task capacity)" 5 ${TOTAL_REQUESTS}

# Test 3: Max single task capacity
echo -e "${BLUE}━━━ Test 3: Maximum Single Task Capacity ━━━${NC}"
run_test "10 concurrent connections (1 task max)" 10 ${TOTAL_REQUESTS}

# Test 4: Trigger auto-scaling
echo -e "${BLUE}━━━ Test 4: Auto-Scaling Test ━━━${NC}"
echo -e "${YELLOW}⚠ This should trigger auto-scaling (may see some slower responses)${NC}"
echo ""
run_test "20 concurrent connections (requires 2 tasks)" 20 ${TOTAL_REQUESTS}

# Test 5: High load
echo -e "${BLUE}━━━ Test 5: High Load ━━━${NC}"
echo -e "${YELLOW}⚠ This will stress the system (requires 3-4 tasks)${NC}"
echo ""
run_test "40 concurrent connections (requires 4 tasks)" 40 ${TOTAL_REQUESTS}

# Summary
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${GREEN}✓ Load testing complete${NC}"
echo ""
echo -e "${YELLOW}Capacity Reference:${NC}"
echo "  • 1 task  = 10 concurrent requests (2 workers × 5 threads)"
echo "  • 2 tasks = 20 concurrent requests"
echo "  • 3 tasks = 30 concurrent requests"
echo "  • 4 tasks = 40 concurrent requests (maximum auto-scale)"
echo ""
echo -e "${YELLOW}Check ECS status:${NC}"
echo "  aws ecs describe-services \\"
echo "    --cluster jiki-production \\"
echo "    --services jiki-api-web \\"
echo "    --query 'services[0].[desiredCount,runningCount]' \\"
echo "    --region eu-west-1 --profile jiki"
echo ""
echo -e "${YELLOW}Monitor CloudWatch logs:${NC}"
echo "  aws logs tail /ecs/jiki-api-web --follow --region eu-west-1 --profile jiki"
echo ""
